<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›†è´¤æ™ºèƒ½æŸ¥å¯ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        body { 
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
        }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ç»ç’ƒæ‹Ÿæ€æ•ˆæœ */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }
        
        /* æ•°å­—ä¸“ç”¨å­—ä½“ */
        .font-mono-num { font-family: 'JetBrains Mono', monospace; }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 0.6rem; }
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800" x-data="attendanceApp()" x-init="initApp()">

    <header class="glass z-50 shadow-sm relative shrink-0">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>

        <div class="px-4 pt-4 pb-2">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 font-mono-num tracking-tight" x-text="currentTime">00:00:00</h1>
                    <p class="text-xs text-gray-500 font-medium mt-1 uppercase tracking-wide" x-text="currentDate">LOADING...</p>
                </div>
                
                <div class="flex flex-col items-end gap-2">
                    <button @click="resetAllData()" class="bg-gray-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg shadow-gray-300/50 active:scale-95 transition flex items-center gap-1">
                        ğŸ”„ å¼€å¯æ–°ä¸€è½®
                    </button>
                    <button @click="showHistory = true" class="text-blue-600 text-xs font-medium hover:underline">
                        æŸ¥çœ‹å†å²è®°å½•
                    </button>
                </div>
            </div>
            
            <div class="mt-4 flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <div class="bg-green-50 text-green-700 px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border border-green-100 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    ç•™å®¿ <span x-text="stayingCount">0</span>
                </div>
                <div class="bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border border-blue-100 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                    å›å®¶ <span x-text="homeCount">0</span>
                </div>
                <div class="bg-red-50 text-red-700 px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border border-red-100 flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-red-500"></span>
                    å¼‚å¸¸ <span x-text="abnormalCount">0</span>
                </div>
            </div>
        </div>

        <div class="mt-2 flex border-t border-gray-100">
            <button @click="activeTab = 'female'" 
                class="flex-1 py-3 text-sm font-bold transition-all relative"
                :class="activeTab === 'female' ? 'text-pink-600 bg-pink-50/50' : 'text-gray-400 hover:text-gray-600'">
                ğŸ‘© 3æ¥¼å¥³ç”Ÿ
                <div x-show="activeTab === 'female'" class="absolute bottom-0 left-0 w-full h-0.5 bg-pink-500"></div>
            </button>
            <button @click="activeTab = 'male'" 
                class="flex-1 py-3 text-sm font-bold transition-all relative"
                :class="activeTab === 'male' ? 'text-blue-600 bg-blue-50/50' : 'text-gray-400 hover:text-gray-600'">
                ğŸ‘¨ 5æ¥¼ç”·ç”Ÿ
                <div x-show="activeTab === 'male'" class="absolute bottom-0 left-0 w-full h-0.5 bg-blue-500"></div>
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-3 space-y-4 bg-gray-50/50 pb-32">
        <template x-for="room in activeList" :key="room.id">
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100/50">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xl font-bold text-gray-700 font-mono-num" x-text="room.id"></span>
                        <span class="bg-gray-100 text-gray-500 text-[10px] px-1.5 py-0.5 rounded" x-text="room.students.length+'äºº'"></span>
                    </div>
                    <div class="flex gap-1.5">
                        <button @click="clearRoom(room.id)" class="w-7 h-7 flex items-center justify-center rounded-lg bg-gray-100 text-gray-400 hover:bg-gray-200 active:bg-gray-300 transition" title="æ¸…é™¤è¯¥å®¿èˆçŠ¶æ€">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                        <div class="w-px h-6 bg-gray-200 mx-1"></div>
                        <button @click="markRoomStatus(room.id, 'home')" class="px-2.5 py-1 rounded-lg bg-blue-50 text-blue-600 text-xs font-bold border border-blue-100 active:bg-blue-100">å…¨å›å®¶</button>
                        <button @click="markRoomStatus(room.id, 'present')" class="px-2.5 py-1 rounded-lg bg-green-50 text-green-600 text-xs font-bold border border-green-100 active:bg-green-100">å…¨ç•™å®¿</button>
                    </div>
                </div>
                
                <div class="card-grid">
                    <template x-for="student in room.students" :key="student.name">
                        <button 
                            @click="toggleStatus(room.id, student.name)"
                            class="relative aspect-square rounded-xl flex flex-col items-center justify-center p-1 transition-all duration-200 border-2 active:scale-90"
                            :class="getStatusClass(student.status)"
                        >
                            <div class="w-1.5 h-1.5 rounded-full mb-1" :class="getDotClass(student.status)"></div>
                            
                            <span class="text-sm font-bold truncate w-full text-center leading-tight" x-text="formatName(student.name)"></span>
                            <span class="text-[9px] mt-0.5 font-medium opacity-80 scale-90" x-text="getStatusLabel(student.status)"></span>
                        </button>
                    </template>
                </div>
            </div>
        </template>
        
        <div class="h-8 text-center text-gray-300 text-xs pt-2">â€”â€” åˆ°åº•äº† â€”â€”</div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 p-3 pb-6 bg-white/80 backdrop-blur-md border-t border-gray-200 z-40 flex gap-3 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
        <button @click="copyLeaderReport()" class="flex-1 bg-gray-800 text-white py-3 rounded-2xl font-bold shadow-xl active:scale-[0.98] transition flex flex-col items-center justify-center">
            <span class="text-sm">ğŸ“‹ é¢†å¯¼æ±‡æŠ¥</span>
            <span class="text-[10px] text-gray-300 font-normal">ç”Ÿæˆç»Ÿè®¡æ•°æ®</span>
        </button>
        <button @click="copyParentReport()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-3 rounded-2xl font-bold shadow-xl shadow-green-200 active:scale-[0.98] transition flex flex-col items-center justify-center">
            <span class="text-sm">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿å…¬ç¤º</span>
            <span class="text-[10px] text-green-100 font-normal">ç”Ÿæˆç•™å®¿åå•</span>
        </button>
    </div>

    <div x-show="showHistory" x-cloak class="fixed inset-0 z-[60] bg-black/30 backdrop-blur-sm transition-opacity" @click.self="showHistory = false">
        <div class="absolute right-0 top-0 bottom-0 w-full max-w-sm bg-white shadow-2xl flex flex-col transform transition-transform duration-300"
             x-transition:enter="translate-x-full" x-transition:enter-end="translate-x-0"
             x-transition:leave="translate-x-0" x-transition:leave-end="translate-x-full">
            <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                <h2 class="font-bold text-xl text-gray-800">æŸ¥å¯æ¡£æ¡ˆ</h2>
                <button @click="showHistory = false" class="w-8 h-8 rounded-full bg-white text-gray-500 flex items-center justify-center shadow hover:bg-gray-100">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/30">
                <template x-if="history.length === 0">
                    <div class="flex flex-col items-center justify-center h-40 text-gray-400">
                        <span class="text-4xl mb-2">ğŸ“‚</span>
                        <p class="text-sm">æš‚æ— å†å²è®°å½•</p>
                    </div>
                </template>
                <template x-for="(record, index) in history" :key="index">
                    <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm relative group">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-sm font-bold text-gray-800" x-text="record.date"></span>
                            <span class="text-xs text-gray-400 font-mono-num" x-text="record.time"></span>
                        </div>
                        <div class="p-2 bg-gray-50 rounded text-xs text-gray-600 leading-relaxed font-mono" x-text="record.report"></div>
                        <button @click="deleteHistory(index)" class="absolute top-2 right-2 text-red-400 opacity-0 group-hover:opacity-100 transition p-1 hover:bg-red-50 rounded">ğŸ—‘ï¸</button>
                    </div>
                </template>
            </div>
            <div class="p-4 border-t bg-white">
                <button @click="archiveData()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition">
                    ğŸ’¾ ä¿å­˜å½“å‰è®°å½•åˆ°æ¡£æ¡ˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        function attendanceApp() {
            return {
                activeTab: 'female',
                showHistory: false,
                currentTime: '00:00:00',
                currentDate: '',
                history: [],
                statusData: {},
                
                // æ•°æ®æº
                dormData: {
                    female: [
                        { id: '301', students: ['è”¡æ™“å‡¤2','é»„èŠ·é¢2'] },
                        { id: '302', students: ['æ´ªé¢–ç¥¯1','ç‹æ¶µ1','é™ˆæ¬£ç²1','é˜®å½©å²š1','éƒ­å†°è‰³1'] },
                        { id: '304', students: ['æ½˜å©§è¹1','å´æ™¨å¾®1','è©¹åœ£å¨œ1','é™ˆå®æ™¶1','åº„äº¦è²1','é»„å†°é“ƒ1'] },
                        { id: '307', students: ['æçŠ2','ç‹æ€ç’2'] },
                        { id: '309', students: ['éƒ‘é¦¨æ½¼2','ç‹ç´çº¹2','é™ˆè¯—é’°2','åˆ˜èŠ³å†°2','ç‹é™æ€¡2','æ—ç»å½¤2'] },
                        { id: '310', students: ['å‚…å®é™1','ææ€æ¸”1','æ—èŒ¹é¢–1','åˆ˜ç‡•æ•1'] },
                        { id: '311', students: ['èµ–æœ¨é¦™1','å¼ æ·‘ä¸½2','å¼ çªæ¶µ2','æˆ´çƒ¨1'] },
                        { id: '313', students: ['é»„ç‡•å¦‚1','åº·ç‘œè±1','ä¸˜èˆ’ç´1','è‚–ç‡•çº¢1','ä½™ç¿1','æ—é’°å©·1'] },
                        { id: '314', students: ['é™ˆå§æ¶µ2','æ›¾å¦‚è2','é™ˆè¯—çª2','é»„å©‰å©·2','åˆ˜è¯—å©·2'] },
                        { id: '316', students: ['è®¸æ€æ±2','ç‹æ¢¦çª2','è‹é“ƒè‰³2','æ—æ™ºç²2','æ¨å†¬è²2','ç‹ç´«é‘«2'] },
                        { id: '318', students: ['æ—ç¾å¿ƒ1','åˆ˜æ€¡å©·1','å‘¨çš–ä¹1','ç‹æ™“è‰º1'] },
                        { id: '320', students: ['ç« æ©çª2','æ›¾é›ªå‡Œ2','åº„å®‰å¦®1','å€ªå«æ›¦2'] }
                    ],
                    male: [
                        { id: '508', students: ['ç‹è´è¶Š1','é™ˆå‡¯æ˜1','æ›¾æ¯…1','æ—å…¸æ³½1','å´æ¡å®‡1','å´ç‚«æ°1','å¼ ä¿Šæ°1'] },
                        { id: '510', students: ['è”¡é€¸é¸¿1','é»„æ—­æ–Œ1','é‚¹æ™ºæ·¼1','é™ˆä¹¦å‹‡1','èŒƒæ˜ŒèŒ‚1','åº„æ±Ÿæ£®2','æ—é’°æ’1'] },
                        { id: '512', students: ['é™ˆä¿Šå…´1','è®¸ç…œè±ª1','é™ˆæµ·æ—1','å´æ°¸æ°1','é¢œå¤©æ—­2','çŸ³èˆª2'] },
                        { id: '514', students: ['åˆ˜ä¿Šè±ª2','é™ˆå­æ¡¢2','é™ˆæ¶›2','å‘¨æ˜±æ­2','æ¨è¯‘é¹2','æ±Ÿåˆ©å½¬2'] },
                        { id: '516', students: ['é­å‡Œäº‘1','å¢ç’Ÿè€€1','é™ˆæ³“ç¿1','å°¤éº’æº2','é’Ÿèˆ’èˆª2','æ´ªæ€é‘«2'] }
                    ]
                },

                initApp() {
                    // å¯åŠ¨æ—¶é’Ÿ
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);

                    // è¯»å–å†å²
                    const savedHistory = localStorage.getItem('weekend_history_pro');
                    if (savedHistory) this.history = JSON.parse(savedHistory);

                    // è¯»å–çŠ¶æ€
                    const savedStatus = localStorage.getItem('weekend_status_pro');
                    if (savedStatus) {
                        this.statusData = JSON.parse(savedStatus);
                    } else {
                        this.initializeStatus();
                    }

                    // è‡ªåŠ¨ä¿å­˜ç›‘å¬
                    this.$watch('statusData', (val) => {
                        localStorage.setItem('weekend_status_pro', JSON.stringify(val));
                    });
                },

                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleTimeString('en-US', {hour12: false}); // 24å°æ—¶åˆ¶
                    this.currentDate = now.toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'short'});
                },

                initializeStatus() {
                    ['female', 'male'].forEach(type => {
                        this.dormData[type].forEach(room => {
                            room.students.forEach(name => {
                                this.statusData[`${room.id}-${name}`] = 'unknown';
                            });
                        });
                    });
                },

                // å…¨å±€é‡ç½®ï¼ˆå¼€å¯æ–°ä¸€è½®ï¼‰
                resetAllData() {
                    if(confirm('âš ï¸ ç¡®å®šè¦å¼€å¯æ–°ä¸€è½®æŸ¥å¯å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤å½“å‰é¡µé¢æ‰€æœ‰å­¦ç”Ÿçš„çŠ¶æ€ã€‚')) {
                        this.initializeStatus(); // é‡ç½®å†…å­˜æ•°æ®
                        // å¼ºåˆ¶æ›´æ–° UI (Alpineæœ‰æ—¶éœ€è¦é‡èµ‹æ–°å¯¹è±¡)
                        this.statusData = JSON.parse(JSON.stringify(this.statusData));
                        alert('å·²é‡ç½®ï¼Œå¯ä»¥å¼€å§‹æ–°çš„æŸ¥å¯äº†ï¼');
                    }
                },

                // å•å®¿èˆæ¸…é™¤
                clearRoom(roomId) {
                    const room = this.dormData[this.activeTab].find(r => r.id === roomId);
                    if(room) {
                        room.students.forEach(name => {
                            this.statusData[`${roomId}-${name}`] = 'unknown';
                        });
                    }
                },

                // æ ¸å¿ƒçŠ¶æ€åˆ‡æ¢é€»è¾‘
                toggleStatus(roomId, name) {
                    const key = `${roomId}-${name}`;
                    const current = this.statusData[key];
                    const flow = {
                        'unknown': 'present',
                        'present': 'home',
                        'home': 'late',
                        'late': 'absent',
                        'absent': 'leave',
                        'leave': 'unknown'
                    };
                    this.statusData[key] = flow[current] || 'present';
                },

                markRoomStatus(roomId, targetStatus) {
                    const room = this.dormData[this.activeTab].find(r => r.id === roomId);
                    if(room) {
                        room.students.forEach(name => {
                            this.statusData[`${roomId}-${name}`] = targetStatus;
                        });
                    }
                },

                // æ ·å¼é€»è¾‘
                getStatusClass(status) {
                    const base = "border-transparent text-gray-400 bg-gray-50"; // unknown
                    const map = {
                        'unknown': base,
                        'present': 'border-green-500 bg-green-50 text-green-700 shadow-sm ring-1 ring-green-100',
                        'home': 'border-blue-400 bg-blue-50 text-blue-600 opacity-60',
                        'late': 'border-orange-500 bg-orange-50 text-orange-700 shadow-sm',
                        'absent': 'border-red-500 bg-red-50 text-red-700 shadow-md animate-pulse',
                        'leave': 'border-yellow-500 bg-yellow-50 text-yellow-700',
                    };
                    return map[status] || base;
                },
                
                getDotClass(status) {
                    return {
                        'unknown': 'bg-gray-300', 'present': 'bg-green-500', 'home': 'bg-blue-400',
                        'late': 'bg-orange-500', 'absent': 'bg-red-500', 'leave': 'bg-yellow-500'
                    }[status];
                },
                getStatusLabel(s) {
                    return {'unknown':'ç‚¹å‡»', 'present':'ç•™å®¿', 'home':'å›å®¶', 'late':'æ™šå½’', 'absent':'å¼‚å¸¸', 'leave':'è¯·å‡'}[s];
                },

                // åˆ—è¡¨ç”Ÿæˆ
                get activeList() {
                    return this.dormData[this.activeTab].map(room => ({
                        id: room.id,
                        students: room.students.map(name => ({
                            name: name,
                            status: this.statusData[`${room.id}-${name}`] || 'unknown'
                        }))
                    }));
                },

                formatName(name) { return name.replace(/[0-9]/g, ''); },

                // ç»Ÿè®¡
                get allStudents() {
                    let all = [];
                    ['female', 'male'].forEach(t => this.dormData[t].forEach(r => r.students.forEach(n => 
                        all.push({id: r.id, name: n, status: this.statusData[`${r.id}-${n}`]})
                    )));
                    return all;
                },
                get stayingCount() { return this.allStudents.filter(s => ['present','late'].includes(s.status)).length; },
                get homeCount() { return this.allStudents.filter(s => s.status === 'home').length; },
                get abnormalCount() { return this.allStudents.filter(s => s.status === 'absent').length; },

                // æ±‡æŠ¥é€»è¾‘
                copyLeaderReport() {
                    let text = `ã€å‘¨æœ«æŸ¥å¯æ±‡æŠ¥ã€‘\nğŸ“… ${new Date().toLocaleString('zh-CN', {hour12:false})}\n------------------\n`;
                    text += `ç•™å®¿: ${this.stayingCount} | å›å®¶: ${this.homeCount}\n`;
                    
                    let abnormals = this.allStudents.filter(s => s.status === 'absent');
                    let lates = this.allStudents.filter(s => s.status === 'late');
                    
                    if(abnormals.length) {
                        text += `\nâŒ å¼‚å¸¸/æœªå½’:\n` + abnormals.map(s => `${s.id}${this.formatName(s.name)}`).join('ã€');
                    }
                    if(lates.length) {
                        text += `\nâš ï¸ æ™šå½’:\n` + lates.map(s => `${s.id}${this.formatName(s.name)}`).join('ã€');
                    }
                    if(!abnormals.length && !lates.length) text += `\nâœ… ç•™å®¿å­¦ç”Ÿå…¨å‘˜åœ¨å¯ã€‚`;

                    this.copyText(text);
                },

                copyParentReport() {
                    let text = `ã€é›†è´¤æ•™è‚²ã€‘å‘¨æœ«ç•™å®¿åå•å…¬ç¤º\nğŸ“… ${this.currentDate} ${this.currentTime}\n------------------\n`;
                    let has = false;
                    ['female', 'male'].forEach(t => {
                        let header = t==='female'?'ğŸ‘© å¥³ç”Ÿ':'ğŸ‘¨ ç”·ç”Ÿ';
                        let lines = [];
                        this.dormData[t].forEach(r => {
                            let stays = r.students.filter(n => ['present','late'].includes(this.statusData[`${r.id}-${n}`]));
                            if(stays.length) lines.push(`[${r.id}] ${stays.map(n=>this.formatName(n)).join('ã€')}`);
                        });
                        if(lines.length) {
                            text += `\n${header}:\n${lines.join('\n')}\n`;
                            has = true;
                        }
                    });
                    if(!has) text += "\n(æš‚æ— ç•™å®¿å­¦ç”Ÿ)";
                    text += `\næ³¨ï¼šæœªåœ¨åˆ—å­¦ç”Ÿé»˜è®¤ä¸ºå›å®¶/è¯·å‡ã€‚`;
                    this.copyText(text);
                },

                copyText(text) {
                    navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶å†…å®¹ï¼')).catch(() => alert('å¤åˆ¶å¤±è´¥'));
                },

                archiveData() {
                    this.history.unshift({
                        date: this.currentDate, time: this.currentTime,
                        report: `ç•™å®¿:${this.stayingCount} å›å®¶:${this.homeCount} å¼‚å¸¸:${this.abnormalCount}`
                    });
                    localStorage.setItem('weekend_history_pro', JSON.stringify(this.history));
                    alert('å·²å½’æ¡£');
                }
            }
        }
    </script>
</body>
</html>