<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‘¨æœ«ç•™å®¿è€ƒå‹¤ v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style>
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 0.5rem; }
        [x-cloak] { display: none !important; }
        /* é€‰ä¸­çŠ¶æ€çš„ç‰¹æ•ˆ */
        .ring-pulse { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col pb-32" x-data="attendanceApp()" x-init="initApp()">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="px-4 py-3 border-b border-gray-100 flex justify-between items-center bg-blue-600 text-white">
            <div>
                <h1 class="text-lg font-bold">å‘¨æœ«ç•™å®¿æŸ¥å¯</h1>
                <p class="text-xs opacity-80" x-text="currentDateStr"></p>
            </div>
            <div class="flex gap-2">
                <button @click="showHistory = true" class="text-white px-3 py-1.5 rounded-lg text-sm bg-blue-700 active:bg-blue-800 border border-blue-500">
                    å†å²è®°å½•
                </button>
                <button @click="archiveData()" class="bg-white text-blue-700 px-3 py-1.5 rounded-lg text-sm font-bold shadow-sm active:scale-95 transition">
                    ğŸ’¾ ä¿å­˜
                </button>
            </div>
        </div>

        <div class="flex text-sm font-medium text-center bg-white shadow-sm">
            <button @click="activeTab = 'female'" 
                :class="{'border-b-4 border-pink-500 text-pink-600 bg-pink-50 font-bold': activeTab === 'female', 'text-gray-500': activeTab !== 'female'}"
                class="flex-1 py-3 transition-all duration-200">
                ğŸ‘© 3æ¥¼ å¥³ç”Ÿå®¿èˆ
            </button>
            <button @click="activeTab = 'male'" 
                :class="{'border-b-4 border-blue-500 text-blue-600 bg-blue-50 font-bold': activeTab === 'male', 'text-gray-500': activeTab !== 'male'}"
                class="flex-1 py-3 transition-all duration-200">
                ğŸ‘¨ 5æ¥¼ ç”·ç”Ÿå®¿èˆ
            </button>
        </div>
        
        <div class="bg-yellow-50 px-4 py-2 flex justify-between text-xs text-yellow-800 border-b border-yellow-100 items-center">
            <span>ç•™å®¿: <b class="text-green-600 text-sm" x-text="stayingCount"></b> äºº</span>
            <span>å›å®¶: <b class="text-blue-600 text-sm" x-text="homeCount"></b> äºº</span>
            <span>å¼‚å¸¸: <b class="text-red-600 text-sm" x-text="abnormalCount"></b> äºº</span>
        </div>
    </header>

    <main class="flex-1 p-3 space-y-3 overflow-y-auto">
        <template x-for="room in activeList" :key="room.id">
            <div class="bg-white rounded-xl shadow-sm p-3 transition-all duration-300">
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-50">
                    <div class="flex items-baseline gap-2">
                        <span class="text-xl font-bold text-gray-800" x-text="room.id"></span>
                        <span class="text-xs text-gray-400" x-text="room.students.length + 'äºº'"></span>
                    </div>
                    <div class="flex gap-2">
                         <button @click="markRoomStatus(room.id, 'home')" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 active:bg-blue-100">
                            å…¨å›å®¶
                        </button>
                        <button @click="markRoomStatus(room.id, 'present')" class="text-[10px] bg-green-50 text-green-600 px-2 py-1 rounded border border-green-100 active:bg-green-100">
                            å…¨ç•™å®¿
                        </button>
                    </div>
                </div>
                
                <div class="card-grid">
                    <template x-for="student in room.students" :key="student.name">
                        <button 
                            @click="toggleStatus(room.id, student.name)"
                            class="aspect-square rounded-lg flex flex-col items-center justify-center p-1 transition-all duration-150 border active:scale-95 shadow-sm relative overflow-hidden"
                            :class="getStatusClass(student.status)"
                        >
                            <div class="absolute top-0 right-0 w-3 h-3 rounded-bl-lg" 
                                 :class="{'bg-green-500': student.status === 'present', 'bg-blue-500': student.status === 'home', 'bg-red-500': student.status === 'absent'}">
                            </div>

                            <span class="text-sm font-bold truncate w-full text-center z-10" x-text="formatName(student.name)"></span>
                            <span class="text-[10px] mt-1 opacity-90 font-medium z-10" x-text="getStatusLabel(student.status)"></span>
                        </button>
                    </template>
                </div>
            </div>
        </template>
        
        <div class="h-10 text-center text-gray-300 text-xs pt-4">åˆ°åº•äº†</div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur border-t border-gray-200 flex gap-3 z-40 shadow-lg">
        <button @click="copyLeaderReport()" class="flex-1 bg-gray-800 text-white py-3 rounded-xl shadow-lg font-bold active:bg-gray-900 flex flex-col items-center justify-center leading-tight">
            <span>ğŸ“‹ æ±‡æŠ¥ç»™é¢†å¯¼</span>
            <span class="text-[10px] opacity-70 font-normal">ç»Ÿè®¡ä¸å¼‚å¸¸</span>
        </button>
        <button @click="copyParentReport()" class="flex-1 bg-green-600 text-white py-3 rounded-xl shadow-lg font-bold active:bg-green-700 flex flex-col items-center justify-center leading-tight">
            <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ æ±‡æŠ¥ç»™å®¶é•¿</span>
            <span class="text-[10px] opacity-70 font-normal">ç•™å®¿åå•å…¬ç¤º</span>
        </button>
    </div>

    <div x-show="showHistory" x-cloak class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm" @click.self="showHistory = false">
        <div class="bg-white w-full sm:max-w-md h-[80vh] sm:h-[600px] rounded-t-2xl sm:rounded-2xl flex flex-col overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg">æŸ¥å¯å†å²æ¡£æ¡ˆ</h3>
                <button @click="showHistory = false" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <template x-for="(record, index) in history" :key="index">
                    <div class="border rounded-lg p-3 bg-white shadow-sm">
                        <div class="flex justify-between mb-2">
                            <span class="font-bold text-gray-800" x-text="record.date"></span>
                            <span class="text-xs text-gray-400" x-text="record.time"></span>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                            ç•™å®¿: <span x-text="record.stats.staying"></span> | å›å®¶: <span x-text="record.stats.home"></span>
                        </div>
                        <div class="text-sm text-gray-600 bg-gray-50 p-2 rounded whitespace-pre-wrap leading-relaxed" x-text="record.report"></div>
                        <button @click="deleteHistory(index)" class="text-red-400 text-xs mt-2 w-full text-right underline">åˆ é™¤æ­¤æ¡</button>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function attendanceApp() {
            return {
                activeTab: 'female', 
                showHistory: false,
                currentDateStr: new Date().toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'long'}),
                history: [],
                dormData: {
                    female: [
                        { id: '301', students: ['è”¡æ™“å‡¤2','é»„èŠ·é¢2'] },
                        { id: '302', students: ['æ´ªé¢–ç¥¯1','ç‹æ¶µ1','é™ˆæ¬£ç²1','é˜®å½©å²š1','éƒ­å†°è‰³1'] },
                        { id: '304', students: ['æ½˜å©§è¹1','å´æ™¨å¾®1','è©¹åœ£å¨œ1','é™ˆå®æ™¶1','åº„äº¦è²1','é»„å†°é“ƒ1'] },
                        { id: '307', students: ['æçŠ2','ç‹æ€ç’2'] },
                        { id: '309', students: ['éƒ‘é¦¨æ½¼2','ç‹ç´çº¹2','é™ˆè¯—é’°2','åˆ˜èŠ³å†°2','ç‹é™æ€¡2','æ—ç»å½¤2'] },
                        { id: '310', students: ['å‚…å®é™1','ææ€æ¸”1','æ—èŒ¹é¢–1','åˆ˜ç‡•æ•1'] },
                        { id: '311', students: ['èµ–æœ¨é¦™1','å¼ æ·‘ä¸½2','å¼ çªæ¶µ2','æˆ´çƒ¨1'] },
                        { id: '313', students: ['é»„ç‡•å¦‚1','åº·ç‘œè±1','ä¸˜èˆ’ç´1','è‚–ç‡•çº¢1','ä½™ç¿1','æ—é’°å©·1'] },
                        { id: '314', students: ['é™ˆå§æ¶µ2','æ›¾å¦‚è2','é™ˆè¯—çª2','é»„å©‰å©·2','åˆ˜è¯—å©·2'] },
                        { id: '316', students: ['è®¸æ€æ±2','ç‹æ¢¦çª2','è‹é“ƒè‰³2','æ—æ™ºç²2','æ¨å†¬è²2','ç‹ç´«é‘«2'] },
                        { id: '318', students: ['æ—ç¾å¿ƒ1','åˆ˜æ€¡å©·1','å‘¨çš–ä¹1','ç‹æ™“è‰º1'] },
                        { id: '320', students: ['ç« æ©çª2','æ›¾é›ªå‡Œ2','åº„å®‰å¦®1','å€ªå«æ›¦2'] }
                    ],
                    male: [
                        { id: '508', students: ['ç‹è´è¶Š1','é™ˆå‡¯æ˜1','æ›¾æ¯…1','æ—å…¸æ³½1','å´æ¡å®‡1','å´ç‚«æ°1','å¼ ä¿Šæ°1'] },
                        { id: '510', students: ['è”¡é€¸é¸¿1','é»„æ—­æ–Œ1','é‚¹æ™ºæ·¼1','é™ˆä¹¦å‹‡1','èŒƒæ˜ŒèŒ‚1','åº„æ±Ÿæ£®2','æ—é’°æ’1'] },
                        { id: '512', students: ['é™ˆä¿Šå…´1','è®¸ç…œè±ª1','é™ˆæµ·æ—1','å´æ°¸æ°1','é¢œå¤©æ—­2','çŸ³èˆª2'] },
                        { id: '514', students: ['åˆ˜ä¿Šè±ª2','é™ˆå­æ¡¢2','é™ˆæ¶›2','å‘¨æ˜±æ­2','æ¨è¯‘é¹2','æ±Ÿåˆ©å½¬2'] },
                        { id: '516', students: ['é­å‡Œäº‘1','å¢ç’Ÿè€€1','é™ˆæ³“ç¿1','å°¤éº’æº2','é’Ÿèˆ’èˆª2','æ´ªæ€é‘«2'] }
                    ]
                },
                statusData: {},

                initApp() {
                    const savedHistory = localStorage.getItem('weekend_history');
                    if (savedHistory) this.history = JSON.parse(savedHistory);
                    const savedStatus = localStorage.getItem('weekend_status_current');
                    if (savedStatus) this.statusData = JSON.parse(savedStatus);
                    else this.initializeStatus();

                    this.$watch('statusData', (val) => {
                        localStorage.setItem('weekend_status_current', JSON.stringify(val));
                    });
                },

                initializeStatus() {
                    ['female', 'male'].forEach(type => {
                        this.dormData[type].forEach(room => {
                            room.students.forEach(name => {
                                // é»˜è®¤ä¸º unknownï¼ŒæŸ¥å¯æ—¶å†å®š
                                this.statusData[`${room.id}-${name}`] = 'unknown';
                            });
                        });
                    });
                },

                get activeList() {
                    return this.dormData[this.activeTab].map(room => ({
                        id: room.id,
                        students: room.students.map(name => ({
                            name: name,
                            status: this.statusData[`${room.id}-${name}`] || 'unknown'
                        }))
                    }));
                },

                // å‘¨æœ«ä¸“ç”¨çŠ¶æ€å¾ªç¯ï¼šæœªç‚¹ -> åœ¨å¯(ç•™å®¿) -> å›å®¶ -> æ™šå½’ -> å¼‚å¸¸ -> è¯·å‡
                toggleStatus(roomId, name) {
                    const key = `${roomId}-${name}`;
                    const current = this.statusData[key];
                    const flow = {
                        'unknown': 'present', // é»˜è®¤å…ˆç‚¹åœ¨å¯
                        'present': 'home',    // ç‚¹ä¸€ä¸‹å˜å›å®¶
                        'home': 'late',       // å†ç‚¹å˜æ™šå½’
                        'late': 'absent',     // å¼‚å¸¸
                        'absent': 'leave',    // è¯·å‡
                        'leave': 'unknown'
                    };
                    this.statusData[key] = flow[current] || 'present';
                },

                // æ‰¹é‡è®¾ç½®ï¼ˆå…¨ç•™å®¿/å…¨å›å®¶ï¼‰
                markRoomStatus(roomId, targetStatus) {
                    const room = this.dormData[this.activeTab].find(r => r.id === roomId);
                    if(room) {
                        room.students.forEach(name => {
                            const key = `${roomId}-${name}`;
                            // åªæœ‰æœªæ ‡è®°çš„ï¼Œæˆ–è€…å·²ç»æ˜¯ç›®æ ‡çŠ¶æ€ç»„çš„æ‰è¦†ç›–ï¼Œé¿å…è¦†ç›–æ‰ç‰¹æ®Šçš„â€œå¼‚å¸¸â€çŠ¶æ€
                            // è¿™é‡Œç®€åŒ–é€»è¾‘ï¼šå¼ºåˆ¶è¦†ç›–
                            this.statusData[key] = targetStatus;
                        });
                    }
                },

                formatName(name) { return name.replace(/[0-9]/g, ''); },

                getStatusClass(status) {
                    return {
                        'unknown': 'bg-gray-50 border-gray-200 text-gray-400',
                        'present': 'bg-green-100 border-green-500 text-green-700 ring-pulse', // ç•™å®¿é«˜äº®
                        'home': 'bg-blue-50 border-blue-300 text-blue-400 opacity-60', // å›å®¶æ·¡åŒ–
                        'late': 'bg-orange-100 border-orange-500 text-orange-700',
                        'absent': 'bg-red-100 border-red-500 text-red-700',
                        'leave': 'bg-yellow-100 border-yellow-500 text-yellow-700',
                    }[status];
                },

                getStatusLabel(status) {
                    const map = {'unknown':'ç‚¹å‡»', 'present':'ç•™å®¿', 'home':'å›å®¶', 'late':'æ™šå½’', 'absent':'å¼‚å¸¸', 'leave':'è¯·å‡'};
                    return map[status];
                },

                // ç»Ÿè®¡é€»è¾‘
                get allStudents() {
                    let all = [];
                    ['female', 'male'].forEach(t => {
                        this.dormData[t].forEach(r => {
                            r.students.forEach(n => all.push({id: r.id, name: n, status: this.statusData[`${r.id}-${n}`]}));
                        });
                    });
                    return all;
                },
                get stayingCount() { return this.allStudents.filter(s => ['present','late'].includes(s.status)).length; },
                get homeCount() { return this.allStudents.filter(s => s.status === 'home').length; },
                get abnormalCount() { return this.allStudents.filter(s => s.status === 'absent').length; },

                // --- æŠ¥å‘Šç”Ÿæˆæ ¸å¿ƒ ---

                // 1. é¢†å¯¼ç‰ˆï¼šé‡æ•°æ®ï¼Œçœ‹å¼‚å¸¸
                copyLeaderReport() {
                    let text = `ã€å‘¨æœ«æŸ¥å¯æ±‡æŠ¥ã€‘\nğŸ“… ${new Date().toLocaleDateString()}\n`;
                    text += `------------------\n`;
                    text += `å…±è®¡: ${this.allStudents.length}äºº\n`;
                    text += `ğŸ  å›å®¶: ${this.homeCount}äºº\n`;
                    text += `ğŸ›ï¸ ç•™å®¿: ${this.stayingCount}äºº\n`;
                    
                    let abnormals = this.allStudents.filter(s => s.status === 'absent');
                    let lates = this.allStudents.filter(s => s.status === 'late');

                    if(abnormals.length > 0) {
                        text += `\nâŒ å¼‚å¸¸/æœªå½’ (${abnormals.length}äºº):\n`;
                        abnormals.forEach(s => text += `- ${s.id}${this.formatName(s.name)}\n`);
                    }
                    if(lates.length > 0) {
                        text += `\nâš ï¸ æ™šå½’/å¾…å› (${lates.length}äºº):\n`;
                        lates.forEach(s => text += `- ${s.id}${this.formatName(s.name)}\n`);
                    }

                    if(abnormals.length === 0 && lates.length === 0) text += `\nâœ… ç•™å®¿å­¦ç”Ÿå…¨å‘˜åœ¨å¯ï¼Œæƒ…å†µæ­£å¸¸ã€‚`;
                    
                    this.copyText(text, 'é¢†å¯¼æ±‡æŠ¥');
                },

                // 2. å®¶é•¿ç‰ˆï¼šé‡åå•ï¼ŒæŠ¥å¹³å®‰
                copyParentReport() {
                    let text = `ã€é›†è´¤æ•™è‚²ã€‘å‘¨æœ«ç•™å®¿å­¦ç”Ÿåå•å…¬ç¤º\n`;
                    text += `ğŸ“… æŸ¥å¯æ—¶é—´ï¼š${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'})}\n`;
                    text += `------------------\n`;
                    text += `ä»¥ä¸‹å­¦ç”Ÿç›®å‰å·²åœ¨å¯å®¤ï¼Œè¯·å®¶é•¿æ”¾å¿ƒï¼š\n\n`;

                    let hasStaying = false;
                    ['female', 'male'].forEach(type => {
                        let label = type === 'female' ? 'ğŸŒ¸ å¥³ç”Ÿå®¿èˆ' : 'ğŸŒ² ç”·ç”Ÿå®¿èˆ';
                        let floorText = "";
                        
                        this.dormData[type].forEach(r => {
                            // ç­›é€‰å‡º åœ¨å¯(present) å’Œ æ™šå½’(late) çš„å­¦ç”Ÿ
                            let stayingStudents = r.students.filter(n => {
                                const s = this.statusData[`${r.id}-${n}`];
                                return s === 'present' || s === 'late';
                            });

                            if(stayingStudents.length > 0) {
                                hasStaying = true;
                                let names = stayingStudents.map(n => this.formatName(n)).join('ã€');
                                floorText += `[${r.id}] ${names}\n`;
                            }
                        });

                        if(floorText) {
                            text += `${label}ï¼š\n${floorText}\n`;
                        }
                    });

                    if(!hasStaying) text += "ï¼ˆæš‚æ— ç•™å®¿å­¦ç”Ÿè®°å½•ï¼‰\n";
                    text += `\næ³¨ï¼šåå•æœªåˆ—å‡ºè€…é»˜è®¤ä¸ºâ€œå›å®¶â€æˆ–â€œè¯·å‡â€ã€‚`;
                    
                    this.copyText(text, 'å®¶é•¿ç¾¤æ±‡æŠ¥');
                },

                copyText(text, type) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert(`å·²å¤åˆ¶ã€${type}ã€‘å†…å®¹ï¼\nå¯ç›´æ¥å»å¾®ä¿¡ç²˜è´´ã€‚`);
                    }).catch(() => alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æˆªå›¾'));
                },

                archiveData() {
                    const record = {
                        date: new Date().toLocaleDateString(),
                        time: new Date().toLocaleTimeString(),
                        stats: { staying: this.stayingCount, home: this.homeCount },
                        report: `[ç•™å®¿:${this.stayingCount}äºº / å›å®¶:${this.homeCount}äºº]\n` + (this.abnormalCount > 0 ? `å¼‚å¸¸: ${this.abnormalCount}äºº` : "å…¨å‘˜æ­£å¸¸")
                    };
                    this.history.unshift(record);
                    localStorage.setItem('weekend_history', JSON.stringify(this.history));
                    alert('æ•°æ®å·²ä¿å­˜åˆ°å†å²è®°å½•ï¼');
                },
                deleteHistory(index) {
                    if(confirm('åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ')) {
                        this.history.splice(index, 1);
                        localStorage.setItem('weekend_history', JSON.stringify(this.history));
                    }
                }
            }
        }
    </script>
</body>
</html>